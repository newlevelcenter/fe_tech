var audio={types:["mp3"],mode:null,ready:false,obj:window.Audio&&new Audio,init:function(){if(this.inited)return;this.inited=true;if(this.supports_html5()){this.mode="html5";this.type=this.getType();this.setupHtml5API();this.ready=true}else if(this.supports_flash()){this.mode="flash";this.type="mp3";this.buildFlashFallback();this.setupFlashAPI()}else{alert("Не удалось подключить аудио.\nПожалуйста, используйте другой браузер или установите Adobe Flash Player")}},setupHtml5API:function(){this.play=function(){audio.obj.play()};this.pause=function(){audio.obj.pause()};this.stop=function(){if(audio.obj.readyState>1){audio.obj.pause();audio.obj.currentTime=0}};this.paused=function(){return audio.obj.paused};this.ended=function(){return audio.obj.ended};this.src=function(src){if(src&&src!=audio.obj.currentSrc)audio.obj.src=src;else return audio.obj.currentSrc};this.volume=function(value){if(value)audio.obj.volume=value;else return audio.obj.volume};this.duration=function(){return audio.obj.duration}},playSound:function(url,playbackRate){if(!audio.ready||!url)return;var src=url.replace(/\.(?:mp3|ogg)(\?.*?)?$/,"."+this.type+"$1");audio.stop();audio.src(src);if(playbackRate!==undefined&&media_type!=="series"){$(audio.obj).get(0).playbackRate=playbackRate}audio.play()},getType:function(){if(this.types.indexOf("mp3")!=-1&&this.obj.canPlayType("audio/mpeg")){return"mp3"}return false},supports_html5:function(){if(window.opera&&opera.version()<12.5&&opera.version().slice(3)<5&&browser.os!="macos"&&browser.flashEnabled)return false;return this.obj&&this.obj.canPlayType&&!!this.getType()},supports_flash:function(){return browser.flashEnabled},buildFlashFallback:function(){var tmp=document.createElement("div");tmp.innerHTML='<embed id="audio_niftyplayer" name="audio_niftyplayer" width="1" height="1" allowscriptaccess="always" quality="high" type="application/x-shockwave-flash" style="position:absolute;left:-999em"></embed>';audio.obj=tmp.firstChild;audio.obj.src="/mediaplayer/niftyplayer.swf";document.body.appendChild(audio.obj);var t=setInterval(function(){try{if(audio.obj&&audio.obj.PercentLoaded&&audio.obj.PercentLoaded()==100){audio.ready=true;audio.setupFlashAPI();clearInterval(t)}}catch(e){}},15)},setupFlashAPI:function(){var el=audio.obj;this.play=function(){el.TCallLabel&&el.TCallLabel("/","play")};this.pause=function(){el.TCallLabel&&el.TCallLabel("/","pause")};this.stop=function(){el.TCallLabel&&el.TCallLabel("/","stop")};this.paused=function(){return el.GetVariable&&el.GetVariable("playingState")!="playing"};this.ended=function(){return el.GetVariable&&el.GetVariable("playingState")=="finished"};this.src=function(src){if(src){el.SetVariable&&el.SetVariable("currentSong",src);el.TCallLabel&&el.TCallLabel("/","load")}else return el.GetVariable&&el.GetVariable("currentSong")};this.volume=function(value){if(value){el.SetVariable&&el.SetVariable("_volume",value);el.TCallLabel&&el.TCallLabel("/","setVolume")}else return el.GetVariable&&+el.GetVariable("_volume")};this.duration=function(){return el.GetVariable&&+el.GetVariable("_duration")}},addEventListener:function(event_name,callback){if(!this.ready){setTimeout(function(){audio.addEventListener(event_name,callback)},5);return}if(this.mode=="html5"){if(window.jQuery)jQuery(this.obj).on(event_name,callback);else this.obj.addEventListener(event_name,callback,false)}else{if(!this.ready)return;function fire_event(event_name,callback){events=event_name.split(" ");var l=events.length;while(l--){event_name=events[l];if(/\./.test(events[l])){var event_rel=events[l].split(".")[1];event_name=events[l].split(".")[0]}var flash_events="onPlay onStop onPause onError onSongOver onBufferingComplete onBufferingStarted".split(" ");var html5_events="play stop pause error ended loadeddata loadedmetadata".split(" ");var event_index=html5_events.indexOf(event_name);if(event_index==-1)return;var flash_event_name=flash_events[event_index];var cb_name="_evt_"+flash_event_name;if(event_rel)cb_name+="_"+event_rel;audio.obj[cb_name]=callback;audio.obj.SetVariable(flash_event_name,"audio.obj."+cb_name+"()");if(audio.obj[cb_name+"_itv"])clearInterval(audio.obj[cb_name+"_itv"]);audio.obj[cb_name+"_itv"]=setInterval("audio.obj.SetVariable('"+flash_event_name+"', 'audio.obj."+cb_name+"()');",8)}}var events;if(typeof event_name=="object"){for(var ev in event_name){fire_event(ev,event_name[ev])}}else{fire_event(event_name,callback)}}},removeEventListener:function(event_name,callback){if(audio.mode=="html5"){if(window.jQuery)$(audio.obj).off(event_name);else audio.obj.removeEventListener(event_name,callback,false)}else{audio.addEventListener(event_name,function(){})}}};